name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y bats
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install bats-core
          fi

      - name: Make script executable
        run: chmod +x gh-commit-ai

      - name: Run unit tests
        run: |
          bats tests/test_core_functions.bats
          bats tests/test_cli.bats
          bats tests/test_branch_intelligence.bats
          bats tests/test_mock_responses.bats

  workflow-tests:
    name: Workflow Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y bats
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install bats-core
          fi

      - name: Make script executable
        run: chmod +x gh-commit-ai

      - name: Run workflow tests
        run: bats tests/test_e2e_workflows.bats

  integration-tests-ollama:
    name: Integration Tests (Ollama)
    runs-on: ubuntu-latest
    # Only run Ollama tests on main branch to save CI time
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama service
        run: |
          ollama serve &
          sleep 5

      - name: Pull test model
        run: |
          ollama pull gemma2:2b

      - name: Install Bats
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Make script executable
        run: chmod +x gh-commit-ai

      - name: Run Ollama integration tests
        env:
          AI_PROVIDER: ollama
          OLLAMA_MODEL: gemma2:2b
        run: bats tests/test_integration_ollama.bats

  integration-tests-anthropic:
    name: Integration Tests (Anthropic)
    runs-on: ubuntu-latest
    # Only run if API key is available
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Make script executable
        run: chmod +x gh-commit-ai

      - name: Run Anthropic integration tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            bats tests/test_integration_anthropic.bats
          else
            echo "Skipping Anthropic tests - no API key"
          fi

  integration-tests-openai:
    name: Integration Tests (OpenAI)
    runs-on: ubuntu-latest
    # Only run if API key is available
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Make script executable
        run: chmod +x gh-commit-ai

      - name: Run OpenAI integration tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -n "$OPENAI_API_KEY" ]; then
            bats tests/test_integration_openai.bats
          else
            echo "Skipping OpenAI tests - no API key"
          fi

  lint:
    name: Shellcheck Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: shellcheck -x gh-commit-ai || true
        # Use || true to make this non-blocking initially

  coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests, workflow-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Make script executable
        run: chmod +x gh-commit-ai

      - name: Run all tests with TAP output
        run: |
          bats --tap tests/*.bats > test-results.tap || true

      - name: Generate summary
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Files:" >> $GITHUB_STEP_SUMMARY
          echo "- Core Functions" >> $GITHUB_STEP_SUMMARY
          echo "- CLI" >> $GITHUB_STEP_SUMMARY
          echo "- Branch Intelligence" >> $GITHUB_STEP_SUMMARY
          echo "- Mock Responses" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Workflows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results.tap ]; then
            passed=$(grep -c "^ok" test-results.tap || echo 0)
            failed=$(grep -c "^not ok" test-results.tap || echo 0)
            echo "✅ Passed: $passed" >> $GITHUB_STEP_SUMMARY
            if [ "$failed" -gt 0 ]; then
              echo "❌ Failed: $failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
