#!/usr/bin/env bash

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
AI_PROVIDER="${AI_PROVIDER:-ollama}"  # Options: ollama, anthropic, openai
OLLAMA_MODEL="${OLLAMA_MODEL:-gemma3:12b}"
OLLAMA_HOST="${OLLAMA_HOST:-http://localhost:11434}"
ANTHROPIC_MODEL="${ANTHROPIC_MODEL:-claude-3-5-sonnet-20241022}"
ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}"
OPENAI_MODEL="${OPENAI_MODEL:-gpt-4o-mini}"
OPENAI_API_KEY="${OPENAI_API_KEY:-}"

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}Error: Not a git repository${NC}"
    exit 1
fi

# Check if there are changes to commit
if git diff --cached --quiet && git diff --quiet; then
    echo -e "${YELLOW}No changes to commit${NC}"
    exit 0
fi

# Get git status and diff
echo -e "${GREEN}Analyzing changes...${NC}"
GIT_STATUS=$(git status --short)
GIT_DIFF=$(git diff --cached 2>/dev/null || echo "")

# If nothing is staged, get unstaged diff
if [ -z "$GIT_DIFF" ]; then
    GIT_DIFF=$(git diff 2>/dev/null || echo "")
fi

# Prepare prompt for Ollama
PROMPT="You are a helpful assistant that writes concise, clear git commit messages following conventional commit format.

CRITICAL: All commit messages must use lowercase letters only. The ONLY exceptions are:
- Acronyms (API, HTTP, JSON, etc.)
- Ticket numbers (EWQ-123, JIRA-456, etc.)

Examples of CORRECT format:
- feat: add user authentication with JWT tokens
- fix: resolve API connection timeout issue
- chore: update dependencies for EWQ-123

Examples of WRONG format (DO NOT USE):
- feat: Add User Authentication (incorrect - uses capital letters)
- fix: Resolve API Connection (incorrect - uses capital letters)

Based on the following git changes, write a single-line commit message. Requirements:
- Start with a type (feat, fix, docs, style, refactor, test, chore)
- Use ONLY lowercase letters (except acronyms and ticket numbers)
- Be in imperative mood (e.g., 'add' not 'added')
- Be clear and concise (max 72 characters)
- Do not include any explanation, just the commit message
- Focus on what the change does, not how it does it
- Analyze the git diff to understand the changes
- Extract ticket information from branch name if present

Git Status:
$GIT_STATUS

Git Diff:
$GIT_DIFF

Remember: Use lowercase only. Respond with ONLY the commit message, nothing else."

# Escape JSON strings (replace backslash, double quote, newline, carriage return, tab)
escape_json() {
    echo "$1" | sed 's/\\/\\\\/g; s/"/\\"/g; s/\n/\\n/g; s/\r/\\r/g; s/\t/\\t/g' | awk '{printf "%s\\n", $0}' | sed '$ s/\\n$//'
}

# Enforce lowercase on commit message while preserving acronyms and ticket numbers
enforce_lowercase() {
    local message="$1"

    # List of common acronyms to preserve (add more as needed)
    local acronyms=("API" "HTTP" "HTTPS" "JSON" "XML" "SQL" "JWT" "OAuth" "REST" "CLI" "UI" "UX" "CSS" "HTML" "JS" "TS" "URL" "URI" "PDF" "CSV" "IDE" "SDK" "CI" "CD" "AWS" "GCP" "DNS" "SSL" "TLS" "SSH" "FTP" "SMTP" "TCP" "UDP" "IP" "DOM" "npm" "NPM" "README" "TODO" "FIXME")

    # First, find and temporarily replace ticket numbers (pattern: ABC-123, WORD-123, etc.)
    # Store them with placeholders
    local temp_message="$message"
    local ticket_pattern='[A-Z][A-Z0-9]+-[0-9]+'
    local counter=0
    declare -A ticket_map

    # Extract ticket numbers
    while read -r ticket; do
        if [ -n "$ticket" ]; then
            local placeholder="__TICKET${counter}__"
            ticket_map["$placeholder"]="$ticket"
            temp_message=$(echo "$temp_message" | sed "s/$ticket/$placeholder/g")
            ((counter++))
        fi
    done < <(echo "$message" | grep -oE "$ticket_pattern")

    # Convert to lowercase
    temp_message=$(echo "$temp_message" | tr '[:upper:]' '[:lower:]')

    # Restore ticket numbers
    for placeholder in "${!ticket_map[@]}"; do
        local ticket="${ticket_map[$placeholder]}"
        temp_message=$(echo "$temp_message" | sed "s/$(echo $placeholder | tr '[:upper:]' '[:lower:]')/$ticket/g")
    done

    # Restore common acronyms
    for acronym in "${acronyms[@]}"; do
        local lowercase_acronym=$(echo "$acronym" | tr '[:upper:]' '[:lower:]')
        # Use word boundaries to avoid partial matches
        temp_message=$(echo "$temp_message" | sed "s/\b$lowercase_acronym\b/$acronym/g")
    done

    echo "$temp_message"
}

# Call Ollama API
call_ollama() {
    local prompt="$1"
    echo -e "${GREEN}Generating commit message with $OLLAMA_MODEL...${NC}"

    local model_escaped=$(escape_json "$OLLAMA_MODEL")
    local prompt_escaped=$(escape_json "$prompt")
    local json_payload=$(printf '{"model":"%s","prompt":"%s","stream":false}' "$model_escaped" "$prompt_escaped")

    local response=$(curl -s -X POST "$OLLAMA_HOST/api/generate" \
        -H "Content-Type: application/json" \
        -d "$json_payload")

    # Extract commit message from response
    echo "$response" | grep -o '"response":"[^"]*"' | sed 's/"response":"//;s/"$//' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
}

# Call Anthropic API
call_anthropic() {
    local prompt="$1"

    if [ -z "$ANTHROPIC_API_KEY" ]; then
        echo -e "${RED}Error: ANTHROPIC_API_KEY is not set${NC}"
        exit 1
    fi

    echo -e "${GREEN}Generating commit message with $ANTHROPIC_MODEL...${NC}"

    local prompt_escaped=$(escape_json "$prompt")
    local json_payload=$(printf '{"model":"%s","max_tokens":1024,"messages":[{"role":"user","content":"%s"}]}' "$ANTHROPIC_MODEL" "$prompt_escaped")

    local response=$(curl -s -X POST "https://api.anthropic.com/v1/messages" \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "$json_payload")

    # Extract commit message from response
    # Anthropic returns: {"content":[{"text":"...","type":"text"}],...}
    echo "$response" | grep -o '"text":"[^"]*"' | head -1 | sed 's/"text":"//;s/"$//' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
}

# Call OpenAI API
call_openai() {
    local prompt="$1"

    if [ -z "$OPENAI_API_KEY" ]; then
        echo -e "${RED}Error: OPENAI_API_KEY is not set${NC}"
        exit 1
    fi

    echo -e "${GREEN}Generating commit message with $OPENAI_MODEL...${NC}"

    local prompt_escaped=$(escape_json "$prompt")
    local json_payload=$(printf '{"model":"%s","messages":[{"role":"user","content":"%s"}],"temperature":0.7}' "$OPENAI_MODEL" "$prompt_escaped")

    local response=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $OPENAI_API_KEY" \
        -d "$json_payload")

    # Extract commit message from response
    # OpenAI returns: {"choices":[{"message":{"content":"..."},...}],...}
    echo "$response" | grep -o '"content":"[^"]*"' | head -1 | sed 's/"content":"//;s/"$//' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
}

# Call the appropriate AI provider
case "$AI_PROVIDER" in
    ollama)
        COMMIT_MSG=$(call_ollama "$PROMPT")
        ;;
    anthropic)
        COMMIT_MSG=$(call_anthropic "$PROMPT")
        ;;
    openai)
        COMMIT_MSG=$(call_openai "$PROMPT")
        ;;
    *)
        echo -e "${RED}Error: Unknown AI provider '$AI_PROVIDER'${NC}"
        echo "Supported providers: ollama, anthropic, openai"
        exit 1
        ;;
esac

if [ -z "$COMMIT_MSG" ] || [ "$COMMIT_MSG" = "null" ]; then
    echo -e "${RED}Error: Failed to generate commit message${NC}"
    echo "Please check your API configuration and try again."
    exit 1
fi

# Enforce lowercase (preserving acronyms and ticket numbers)
COMMIT_MSG=$(enforce_lowercase "$COMMIT_MSG")

# Show the generated commit message
echo -e "\n${GREEN}Generated commit message:${NC}"
echo -e "${YELLOW}$COMMIT_MSG${NC}\n"

# Ask for confirmation
read -p "Use this commit message? (y/n/e to edit): " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
    # Stage all changes if nothing is staged
    if git diff --cached --quiet; then
        echo -e "${GREEN}Staging all changes...${NC}"
        git add -A
    fi

    # Commit with the generated message
    git commit -m "$COMMIT_MSG"
    echo -e "${GREEN}✓ Committed successfully!${NC}"
elif [[ $REPLY =~ ^[Ee]$ ]]; then
    # Allow user to edit the message
    git commit -e -m "$COMMIT_MSG"
    echo -e "${GREEN}✓ Committed with edited message!${NC}"
else
    echo -e "${YELLOW}Commit cancelled${NC}"
    exit 0
fi
